name: "Run terraform plan and create PR comment"
description: "Runs terraform plan and adds a comment to the PR if it contains changes"

inputs:
  cmd:
    description: "The terraform plan command. '-detailed-exitcode' will be added by this action"
    required: false
    default: terraform plan
  environment:
    description: "The name of the environment to add to the description"
    required: false
  working-directory:
    description: "The directory to run the terraform plan command in"
    required: false
    default: .
  github-token:
    description: "The GitHub token to use for authentication for creating the PR comment"
    required: true

runs:
  using: "composite"

  steps:
    - name: Run terraform plan
      id: plan
      shell: bash
      # workaround for continue-on-failure: true not available in composite actions
      run: |
        PLAN_STDOUT=$( ${{ inputs.cmd }} -detailed-exitcode && echo "::set-output name=exitcode::0" || echo "::set-output name=exitcode::$?")
        echo "::set-output name=stdout::$PLAN_STDOUT"
      working-directory: ${{ inputs.working-directory }}

    - name: Add PR comment if plan has changes
      if: steps.plan.outputs.exitcode == '2'
      uses: d-i-p/terraform-actions/plan-pr-comment@main
      with:
        github-token: ${{ inputs.github-token }}
        plan-stdout: ${{ steps.plan.outputs.stdout }}
        environment: ${{ inputs.environment }}

    - name: Exit if terraform plan failed
      if: steps.plan.outputs.exitcode == '1'
      shell: bash
      run: exit 1
